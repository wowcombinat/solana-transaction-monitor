<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token History</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        body {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
            padding-top: 20px;
            overflow-x: hidden;
        }
        .container {
            max-width: 800px;
        }
        .card {
            background-color: #111;
            border: 1px solid #0f0;
            margin-bottom: 20px;
        }
        .card-title {
            color: #0f0;
        }
        table {
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #0f0;
        }
        th {
            background-color: #222;
        }
        td {
            background-color: #111;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .page-item {
            margin: 0 5px;
        }
        .page-link {
            color: #0f0;
            background-color: #111;
            border: 1px solid #0f0;
            cursor: pointer;
        }
        #home-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.5s;
        }
        #home-button:hover {
            transform: scale(1.1);
        }
        #home-button:active {
            transform: scale(0.9);
        }
        .mint-link {
            color: #0f0;
            text-decoration: underline;
            cursor: pointer;
        }
        .mint-link:hover {
            color: #ff0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Token History</h1>
        <div id="token-history" class="mt-4"></div>
        <div class="pagination">
            <button class="page-link" id="prev-page">Previous</button>
            <span id="page-info"></span>
            <button class="page-link" id="next-page">Next</button>
        </div>
        <button id="home-button">HOME</button>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;

        async function fetchTokenHistory(page) {
            try {
                const response = await fetch(`/api/tokens?page=${page}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (!data || !data.tokens) {
                    throw new Error('Invalid data received from server');
                }

                const { tokens, total, totalPages: pages, currentPage: current } = data;
                totalPages = pages;
                currentPage = current;

                document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
                
                const tokenHistoryDiv = document.getElementById('token-history');
                tokenHistoryDiv.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Mint Address</th>
                                <th>Holders (%)</th>
                                <th>Sales</th>
                                <th>Purchases</th>
                                <th>Price</th>
                                <th>Symbol</th>
                                <th>Time</th>
                                <th>Relationships</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tokens.map(token => `
                                <tr>
                                    <td><span class="mint-link" onclick="window.location.href='/token.html?mint=${token.mint}'">${token.mint}</span></td>
                                    <td>${token.holders || 'N/A'}</td>
                                    <td>${token.sales || 'N/A'}</td>
                                    <td>${token.purchases || 'N/A'}</td>
                                    <td>${token.price || 'N/A'}</td>
                                    <td>${token.symbol || 'N/A'}</td>
                                    <td>${token.timestamp ? new Date(token.timestamp).toLocaleString() : 'N/A'}</td>
                                    <td>${JSON.stringify(token.relationships) || 'N/A'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                updatePaginationButtons();
            } catch (error) {
                console.error('Error fetching token history:', error);
                document.getElementById('token-history').innerHTML = `<p>Error loading token history. Please try again later. Details: ${error.message}</p>`;
            }
        }

        function updatePaginationButtons() {
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                fetchTokenHistory(currentPage);
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                fetchTokenHistory(currentPage);
            }
        });

        document.getElementById('home-button').addEventListener('click', () => {
            window.location.href = '/';
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchTokenHistory(currentPage);
        });

        // WebSocket connection for real-time updates
        const ws = new WebSocket(`wss://${window.location.host}`);

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                fetchTokenHistory(currentPage);
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
            console.log('WebSocket connection closed. Reconnecting...');
            setTimeout(() => {
                window.location.reload();
            }, 5000);
        };
    </script>
</body>
</html>
